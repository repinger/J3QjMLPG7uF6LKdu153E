<!doctype html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Monitorr Dashboard</title>
		<link
			rel="stylesheet"
			href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
		/>
		<link
			rel="stylesheet"
			href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css"
		/>
		<link
			rel="stylesheet"
			href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css"
		/>
		<link
			href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
			rel="stylesheet"
		/>
		<link
			href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap"
			rel="stylesheet"
		/>
		<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
		<link rel="stylesheet" href="/css/style.css" />

		<style>
			.user-profile-section {
				display: flex;
				align-items: center;
				gap: 12px;
				margin-right: 15px;
				padding-right: 20px;
				border-right: 1px solid #e2e8f0; /* Border abu-abu halus */
				height: 32px;
			}
			.user-info-text {
				display: flex;
				flex-direction: column;
				justify-content: center;
				text-align: right;
			}
			.user-name {
				font-weight: 700;
				font-size: 0.9rem;
				color: #0f172a; /* Warna Gelap */
				line-height: 1.2;
			}
			.user-role {
				font-size: 0.75rem;
				color: #64748b; /* Warna Abu-abu */
				text-transform: uppercase;
				letter-spacing: 0.5px;
			}
			.user-avatar {
				width: 38px;
				height: 38px;
				background: #f1f5f9; /* Abu-abu sangat muda */
				border-radius: 50%;
				display: flex;
				align-items: center;
				justify-content: center;
				border: 1px solid #e2e8f0;
				color: #4f46e5; /* Icon Primary Color */
			}
			/* Styling khusus untuk Modal Geo */
			.geo-list-container {
				max-height: 200px;
				overflow-y: auto;
				border: 1px solid #e2e8f0;
				border-radius: 6px;
				padding: 10px;
				background: #f8fafc;
			}
			.geo-rule-item {
				background: white;
				border: 1px solid #e2e8f0;
				padding: 8px 12px;
				border-radius: 6px;
				margin-bottom: 8px;
				font-size: 0.9rem;
			}
			.geo-rule-header {
				font-weight: 700;
				color: #334155;
				display: flex;
				justify-content: space-between;
			}
			.geo-rule-badges {
				margin-top: 5px;
				display: flex;
				flex-wrap: wrap;
				gap: 4px;
			}
			.badge-prov {
				background: #eff6ff;
				color: #2563eb;
				border: 1px solid #bfdbfe;
				padding: 2px 8px;
				border-radius: 99px;
				font-size: 0.75rem;
			}
		</style>
	</head>
	<body class="auth-pending">
		<div id="toast-container"></div>

		<header>
			<div class="brand"><i class="fas fa-satellite-dish"></i> Monitorr</div>

			<div class="nav-pills">
				<button
					id="nav-map"
					class="nav-item active"
					onclick="switchView('map')"
				>
					<i class="fas fa-map"></i> Map
				</button>
				<button id="nav-list" class="nav-item" onclick="switchView('list')">
					<i class="fas fa-server"></i> Manage Node
				</button>
			</div>

			<div
				class="header-right"
				style="display: flex; align-items: center; gap: 15px"
			>
				<div class="notification-wrapper" style="position: relative">
					<button
						class="nav-item"
						onclick="toggleNotifications()"
						style="padding: 8px"
					>
						<i class="fas fa-bell"></i>
						<span
							id="notif-badge"
							style="
								display: none;
								position: absolute;
								top: 5px;
								right: 5px;
								width: 8px;
								height: 8px;
								background: #ef4444;
								border-radius: 50%;
								box-shadow: 0 0 0 2px white;
							"
						></span>
					</button>
					<div
						id="notif-dropdown"
						class="notif-dropdown"
						style="display: none; top: 50px"
					>
						<div
							class="notif-header"
							style="
								display: flex;
								justify-content: space-between;
								align-items: center;
								padding: 10px 15px;
								border-bottom: 1px solid #e2e8f0;
							"
						>
							<span style="font-weight: 700; color: #0f172a"
								>Notifications</span
							>
							<div style="display: flex; gap: 10px">
								<button
									onclick="markRead()"
									style="
										font-size: 0.75rem;
										background: none;
										border: none;
										color: var(--primary);
										cursor: pointer;
										font-weight: 600;
									"
								>
									Mark Read
								</button>
								<button
									onclick="clearNotifications()"
									style="
										font-size: 0.75rem;
										background: none;
										border: none;
										color: #ef4444;
										cursor: pointer;
										font-weight: 600;
									"
									title="Hapus Semua"
								>
									Clear All
								</button>
							</div>
						</div>
						<div id="notif-list" class="notif-list"></div>
					</div>
				</div>

				<div class="user-profile-section">
					<div class="user-info-text">
						<div id="nav-username" class="user-name">Loading...</div>
						<div id="nav-role" class="user-role">...</div>
					</div>
					<div class="user-avatar">
						<i class="fas fa-user"></i>
					</div>
				</div>

				<a href="/auth/logout" class="btn-logout" title="Keluar">
					<i class="fas fa-power-off"></i>
				</a>
			</div>
		</header>

		<div class="main-container">
			<div id="view-map" class="view-section active-view">
				<div id="map"></div>
			</div>

			<div id="view-list" class="view-section">
				<div class="container-width">
					<div class="list-header" style="margin-bottom: 10px">
						<div
							style="
								display: flex;
								justify-content: space-between;
								align-items: center;
								width: 100%;
							"
						>
							<div>
								<h2>Manage Node</h2>
								<span class="subtitle">Monitoring & Control</span>
							</div>
							<div id="adminAddBtnWrapper"></div>
						</div>
					</div>

					<div class="shop-layout">
						<aside class="filter-sidebar">
							<div class="sidebar-header">
								<span><i class="fas fa-filter"></i> Filter</span>
								<button onclick="resetFilters()" class="btn-reset">
									Reset
								</button>
							</div>

							<div class="filter-group">
								<div class="search-box">
									<i class="fas fa-search"></i>
									<input
										type="text"
										id="searchInput"
										onkeyup="applyFilters()"
										placeholder="Cari Host/ID..."
									/>
								</div>
							</div>

							<div class="filter-group">
								<h4>Status & Isu</h4>
								<div class="checkbox-list">
									<label class="cb-container">
										<input
											type="checkbox"
											class="filter-cb"
											name="issue"
											value="offline"
											onchange="applyFilters()"
										/>
										<span class="checkmark"></span>
										<span class="cb-label text-danger">Offline</span>
									</label>
									<label class="cb-container">
										<input
											type="checkbox"
											class="filter-cb"
											name="issue"
											value="high_latency"
											onchange="applyFilters()"
										/>
										<span class="checkmark"></span>
										<span class="cb-label text-warning">High Latency</span>
									</label>
									<label class="cb-container">
										<input
											type="checkbox"
											class="filter-cb"
											name="issue"
											value="high_traffic"
											onchange="applyFilters()"
										/>
										<span class="checkmark"></span>
										<span class="cb-label text-info">High Traffic</span>
									</label>
								</div>
							</div>

							<div class="filter-group">
								<h4>Label Perangkat</h4>
								<select
									id="typeFilter"
									onchange="applyFilters()"
									class="sidebar-select"
								>
									<option value="all">Semua Tipe</option>
								</select>
							</div>

							<div class="filter-group">
								<h4>Provinsi</h4>
								<select
									id="provinceFilter"
									onchange="onProvinceChange()"
									class="sidebar-select"
								>
									<option value="all">Semua Provinsi</option>
								</select>
							</div>

							<div class="filter-group">
								<h4>Kota</h4>
								<select
									id="cityFilter"
									onchange="applyFilters()"
									class="sidebar-select"
								>
									<option value="all">Semua Kota</option>
								</select>
							</div>

							<div class="filter-group" id="settingsBar" style="display: none">
								<h4>Pengaturan</h4>
								<button
									onclick="openSettingsModal()"
									class="btn-secondary w-full"
									style="margin-bottom: 8px"
								>
									<i class="fas fa-cog"></i> Config Threshold
								</button>
								<div>
									<button onclick="openGeoModal()" class="btn-secondary w-full">
										<i class="fas fa-globe-asia"></i> Akses Provinsi
									</button>
								</div>
							</div>
						</aside>

						<main class="product-grid-area">
							<div class="top-controls">
								<span
									id="resultCount"
									style="color: var(--text-sub); font-size: 0.9rem"
									>Menampilkan...</span
								>
								<div class="density-control">
									<label>Tampilan:</label>
									<select
										id="densitySelect"
										onchange="changeDensity(this.value)"
									>
										<option value="3">Detail</option>
										<option value="6" selected>Normal</option>
										<option value="12">Compact</option>
										<option value="24">Minimal</option>
									</select>
								</div>
							</div>

							<div id="cards-container" class="card-grid"></div>
							<div id="pagination-controls" class="pagination-wrapper"></div>
						</main>
					</div>
				</div>
			</div>
		</div>

		<div id="addModal" class="modal">
			<div class="modal-content">
				<div class="modal-header">
					<h3>Tambah Node Baru</h3>
					<span class="close-btn" onclick="closeModal('addModal')"
						>&times;</span
					>
				</div>
				<div class="form-group">
					<label>Label Perangkat</label>
					<select id="addTypeSelect" onchange="toggleTypeInput('add')">
						<option value="Server">Server</option>
						<option value="Router">Router</option>
						<option value="custom">Custom (Isi Sendiri...)</option>
					</select>
					<input
						type="text"
						id="addTypeCustom"
						placeholder="Nama Label Custom..."
						style="display: none; margin-top: 8px"
					/>
				</div>

				<div
					style="
						background: #f8fafc;
						padding: 12px;
						border-radius: 8px;
						border: 1px solid #e2e8f0;
						margin-bottom: 16px;
					"
				>
					<label style="margin-bottom: 8px; display: block">Notifikasi</label>
					<div style="display: flex; gap: 15px; flex-wrap: wrap">
						<label
							style="
								display: flex;
								align-items: center;
								gap: 6px;
								font-weight: normal;
								font-size: 0.9rem;
								color: #334155;
							"
							><input type="checkbox" id="addNotifyDown" checked /> Node
							Down</label
						>
						<label
							style="
								display: flex;
								align-items: center;
								gap: 6px;
								font-weight: normal;
								font-size: 0.9rem;
								color: #334155;
							"
							><input type="checkbox" id="addNotifyTraffic" checked /> High
							Traffic</label
						>
						<label
							style="
								display: flex;
								align-items: center;
								gap: 6px;
								font-weight: normal;
								font-size: 0.9rem;
								color: #334155;
							"
							><input type="checkbox" id="addNotifyEmail" /> Kirim Email</label
						>
					</div>
				</div>

				<div class="form-group">
					<label>Pilih Ikon</label
					><input type="hidden" id="addIcon" value="fa-server" />
					<div class="icon-selector-grid" id="addIconGrid"></div>
				</div>
				<div class="form-group">
					<label>Nama / ID (Unik)</label
					><input type="text" id="addId" placeholder="Misal: SRV-01" />
				</div>
				<div class="form-group">
					<label>IP Address / Hostname</label
					><input type="text" id="addHost" placeholder="Misal: 192.168.1.1" />
				</div>
				<div class="form-group">
					<label>Metode Monitoring</label
					><select id="addUseSnmp">
						<option value="0">Ping Only (ICMP)</option>
						<option value="1">Ping + Network Traffic (Prometheus)</option>
					</select>
				</div>
				<div class="row">
					<div class="form-group">
						<label>Lat</label
						><input type="text" id="addLat" readonly class="coord-input" />
					</div>
					<div class="form-group">
						<label>Lng</label
						><input type="text" id="addLng" readonly class="coord-input" />
					</div>
				</div>
				<button class="btn-primary" onclick="submitAdd()">Simpan Node</button>
			</div>
		</div>

		<div id="editModal" class="modal">
			<div class="modal-content">
				<div class="modal-header">
					<h3>Edit Node</h3>
					<span class="close-btn" onclick="closeModal('editModal')"
						>&times;</span
					>
				</div>
				<div class="form-group">
					<label>ID Node</label
					><input type="text" id="editId" readonly class="readonly-input" />
				</div>
				<div class="form-group">
					<label>Label Perangkat</label>
					<select id="editTypeSelect" onchange="toggleTypeInput('edit')">
						<option value="Server">Server</option>
						<option value="Router">Router</option>
						<option value="custom">Custom (Isi Sendiri...)</option>
					</select>
					<input
						type="text"
						id="editTypeCustom"
						placeholder="Nama Label Custom..."
						style="display: none; margin-top: 8px"
					/>
				</div>

				<div
					style="
						background: #f8fafc;
						padding: 12px;
						border-radius: 8px;
						border: 1px solid #e2e8f0;
						margin-bottom: 16px;
					"
				>
					<label style="margin-bottom: 8px; display: block">Notifikasi</label>
					<div style="display: flex; gap: 15px; flex-wrap: wrap">
						<label
							style="
								display: flex;
								align-items: center;
								gap: 6px;
								font-weight: normal;
								font-size: 0.9rem;
								color: #334155;
							"
							><input type="checkbox" id="editNotifyDown" /> Node Down</label
						>
						<label
							style="
								display: flex;
								align-items: center;
								gap: 6px;
								font-weight: normal;
								font-size: 0.9rem;
								color: #334155;
							"
							><input type="checkbox" id="editNotifyTraffic" /> High
							Traffic</label
						>
						<label
							style="
								display: flex;
								align-items: center;
								gap: 6px;
								font-weight: normal;
								font-size: 0.9rem;
								color: #334155;
							"
							><input type="checkbox" id="editNotifyEmail" /> Kirim Email</label
						>
					</div>
				</div>

				<div class="form-group">
					<label>Pilih Ikon</label
					><input type="hidden" id="editIcon" value="fa-server" />
					<div class="icon-selector-grid" id="editIconGrid"></div>
				</div>
				<div class="form-group">
					<label>IP Address</label><input type="text" id="editHost" />
				</div>
				<div class="form-group">
					<label>Metode Monitoring</label
					><select id="editUseSnmp">
						<option value="0">Ping Only (ICMP)</option>
						<option value="1">Ping + Network Traffic (Prometheus)</option>
					</select>
				</div>
				<div class="row">
					<div class="form-group">
						<label>Lat</label><input type="text" id="editLat" />
					</div>
					<div class="form-group">
						<label>Lng</label><input type="text" id="editLng" />
					</div>
				</div>
				<div class="modal-actions">
					<button class="btn-secondary" onclick="closeModal('editModal')">
						Batal</button
					><button class="btn-primary" onclick="submitEdit()">Simpan</button>
				</div>
			</div>
		</div>

		<div id="detailModal" class="modal">
			<div class="modal-content large-modal">
				<div class="modal-header">
					<div>
						<h3 id="detailTitle" style="margin: 0">Node Details</h3>
						<span
							id="detailHost"
							style="color: var(--secondary); font-size: 0.9rem"
						></span>
					</div>
					<div class="chart-controls">
						<select
							id="metricSelect"
							class="chart-select"
							onchange="updateDetailView()"
						>
							<option value="latency">Latency (ms)</option>
							<option value="bandwidth">Bandwidth (Kbps)</option>
							<option value="status">Status Log (Text)</option>
						</select>
						<select
							id="rangeSelect"
							class="chart-select"
							onchange="updateDetailView()"
						>
							<option value="5">5 Menit</option>
							<option value="30">30 Menit</option>
							<option value="60">1 Jam</option>
							<option value="360">6 Jam</option>
							<option value="1440">24 Jam</option>
							<option value="10080">1 Minggu</option>
						</select>
					</div>
					<span class="close-btn" onclick="closeModal('detailModal')"
						>&times;</span
					>
				</div>
				<div class="detail-body">
					<div
						id="chartLoading"
						style="
							display: none;
							position: absolute;
							top: 50%;
							left: 50%;
							transform: translate(-50%, -50%);
							color: var(--secondary);
							z-index: 10;
						"
					>
						Memuat Data...
					</div>
					<div class="chart-container-large" id="chartWrapper">
						<canvas id="detailChart"></canvas>
					</div>
					<div
						id="historyListWrapper"
						style="
							display: none;
							flex: 1;
							overflow-y: auto;
							border: 1px solid #e2e8f0;
							border-radius: 8px;
						"
					>
						<table class="history-table">
							<thead>
								<tr>
									<th width="30%">Waktu</th>
									<th width="20%">Status</th>
									<th width="50%">Detail Metrik</th>
								</tr>
							</thead>
							<tbody id="historyTableBody"></tbody>
						</table>
					</div>
				</div>
			</div>
		</div>

		<div id="deleteModal" class="modal">
			<div class="modal-content small-modal">
				<div class="modal-header">
					<h3 style="color: var(--danger)">Hapus Node?</h3>
					<span class="close-btn" onclick="closeModal('deleteModal')"
						>&times;</span
					>
				</div>
				<p>
					Hapus node <b><span id="delTargetName"></span></b> secara permanen?
				</p>
				<input type="hidden" id="delTargetId" />
				<div class="modal-actions">
					<button class="btn-secondary" onclick="closeModal('deleteModal')">
						Batal</button
					><button class="btn-danger-modal" onclick="submitDelete()">
						Ya, Hapus
					</button>
				</div>
			</div>
		</div>

		<div id="settingsModal" class="modal">
			<div class="modal-content small-modal">
				<div class="modal-header">
					<h3>Konfigurasi Threshold</h3>
					<span class="close-btn" onclick="closeModal('settingsModal')"
						>&times;</span
					>
				</div>
				<div style="padding: 15px">
					<p style="color: #64748b; font-size: 0.9rem; margin-bottom: 15px">
						Atur batas nilai untuk filter High Latency & Traffic.
					</p>

					<div class="form-group" style="margin-bottom: 15px">
						<label style="display: block; margin-bottom: 5px; font-weight: 600"
							>High Latency Threshold (ms)</label
						>
						<input
							type="number"
							id="confLatency"
							class="form-control"
							placeholder="Default: 100"
							style="
								width: 100%;
								padding: 8px;
								border: 1px solid #cbd5e1;
								border-radius: 4px;
							"
						/>
					</div>

					<div class="form-group" style="margin-bottom: 20px">
						<label style="display: block; margin-bottom: 5px; font-weight: 600"
							>High Bandwidth Threshold (Kbps)</label
						>
						<input
							type="number"
							id="confBandwidth"
							class="form-control"
							placeholder="Default: 10000"
							style="
								width: 100%;
								padding: 8px;
								border: 1px solid #cbd5e1;
								border-radius: 4px;
							"
						/>
						<small style="color: #94a3b8; font-size: 0.8rem"
							>10000 Kbps = 10 Mbps</small
						>
					</div>

					<div
						class="modal-actions"
						style="display: flex; justify-content: flex-end; gap: 10px"
					>
						<button
							class="btn-secondary"
							onclick="closeModal('settingsModal')"
							style="
								padding: 8px 16px;
								border: 1px solid #cbd5e1;
								background: white;
								border-radius: 4px;
								cursor: pointer;
							"
						>
							Batal
						</button>
						<button
							class="btn-primary"
							onclick="saveSettings()"
							style="
								padding: 8px 16px;
								background: #2563eb;
								color: white;
								border: none;
								border-radius: 4px;
								cursor: pointer;
							"
						>
							Simpan
						</button>
					</div>
				</div>
			</div>
		</div>

		<div id="geoModal" class="modal">
			<div class="modal-content">
				<div class="modal-header">
					<h3>Atur Akses Provinsi</h3>
					<span class="close-btn" onclick="closeModal('geoModal')"
						>&times;</span
					>
				</div>
				<div class="form-group">
					<label>Pilih Group Authentik</label>
					<select
						id="geoGroupSelect"
						class="sidebar-select"
						style="width: 100%"
					>
						<option value="">Memuat Groups...</option>
					</select>
				</div>

				<div class="form-group">
					<label>Izinkan Provinsi (Pilih Banyak)</label>
					<div id="geoProvinceList" class="geo-list-container">
						<div style="text-align: center; color: #64748b; padding: 10px">
							Memuat Provinsi...
						</div>
					</div>
				</div>

				<button
					class="btn-primary"
					onclick="saveGeoRule()"
					style="width: 100%; margin-bottom: 20px"
				>
					Simpan Rule
				</button>

				<hr
					style="border: 0; border-top: 1px solid #e2e8f0; margin-bottom: 15px"
				/>

				<h4 style="margin-bottom: 10px; color: #334155">Aturan Tersimpan</h4>
				<div id="geoRulesTable" style="max-height: 250px; overflow-y: auto">
					<div style="text-align: center; color: #94a3b8">
						Belum ada aturan.
					</div>
				</div>
			</div>
		</div>

		<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
		<script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
		<script src="/js/app.js"></script>
	</body>
</html>
